<project name="WDK" default="Installation" basedir="."> 

  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo  Dependencies  oooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <import file="${projectsDir}/WSF/build.xml" />


  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo    Checkout    oooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="WDK-ChildCheckout">
    <available file="${projectsDir}/WSF" type="dir"  property="WSF.present" />
    <antcall target="WSF-Checkout"/>
  </target>

  <target name="WSF-Checkout" unless="WSF.present">
    <ant target="defaultProjectCheckout" inheritAll="false">
      <property name="svnurl" value="https://cbilsvn.pmacs.upenn.edu/svn/gus/WSF"/>
      <property name="project" value="WSF"/>
      <property name="version" value="WDK_version_1-28"/>
    </ant>
  </target>

    
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo    Update    oooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="WDK-ChildUpdate">
    <ant target="defaultProjectUpdate">
      <property name="project" value="WSF"/>
    </ant>
  </target>


  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo  Installation  oooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="WDK-Installation" depends="WSF-Installation,
                                           WDK-MavenInstallation,
                                           WDK/Model-Installation,
                                           WDK/Service-Installation">
    <ant target="defaultProjectInstall">
      <property name="project" value="WDK"/>
    </ant>
  </target>

  <target name="WDK-MavenInstallation">
    <ant target="mavenBuildProject">
      <property name="project" value="WDK"/>
    </ant>
    <property name="alreadyBuilt" value="true"/>
  </target>


  <!-- oooooooooooooooooo  Installation Postprocess  ooooooooooooooooooooo -->

  <target name="WDK-Installation-postprocess">
    <echo message="Postprocessing the WDK installation"/>

    <replace dir="${targetDir}/bin" 
             propertyFile="${targetDir}/config/replacements.prop" > 
      <include name="**/*" />
      <replacefilter token="@perl@" property="perl"/>
    </replace> 
    
  </target>

  <!-- ooooooooooooooooooooooo  Install Components  ooooooooooooooooooooooo -->

  <target name="WDK/Model-Installation">

    <antcall target="handleOracleDriver"/>

    <ant target="defaultComponentInstall">
      <property name="project" value="WDK"/>
      <property name="component" value="Model"/>
    </ant>
  </target>  

  <target name="handleOracleDriver">

    <!-- set values for supported Oracle driver -->
    <!-- IMPORTANT CAUTION:  if you update the ojdbc driver here,
	 do so in all other build.xml files that import the driver,
    	 to prevent conflicts in gus_home
    -->
    <property name="oracle.driver.name" value="ojdbc6"/>
    <property name="oracle.version" value="11.2.0.3"/>

    <!-- check existence of Oracle  -->
    <property environment="env"/>
    <condition property="oracle.home.defined">
      <isset property="env.ORACLE_HOME"/>
    </condition>
    <condition property="oracle.home.present">
      <available file="${env.ORACLE_HOME}" type="dir"/>
    </condition>
    <condition property="ojdbc.present">
      <available file="${env.ORACLE_HOME}/jdbc/lib/${oracle.driver.name}.jar" type="file"/>
    </condition>

    <!-- set valuse to false if not already set to true -->
    <property name="oracle.home.present" value="false"/>
    <property name="ojdbc.present" value="false"/>

    <!-- build out specific conditions -->
    <condition property="oracle.home.complete">
      <and>
        <isset property="oracle.home.defined"/>
        <istrue value="${oracle.home.present}"/>
        <istrue value="${ojdbc.present}"/>
      </and>
    </condition>
    <condition property="oracle.home.incomplete">
      <and>
        <isset property="oracle.home.defined"/>
        <or>
          <isfalse value="${oracle.home.present}"/>
          <isfalse value="${ojdbc.present}"/>
        </or>
      </and>
    </condition>

    <!-- perform conditional operations -->
    <antcall target="warnAboutOracleDriver"/>
    <antcall target="copyLocalOracleDriver"/>
    <fail if="oracle.home.incomplete" message="Error: if $ORACLE_HOME is defined, file $ORACLE_HOME/jdbc/lib/${oracle.driver.name}.jar must be available."/>

  </target>

  <target name="warnAboutOracleDriver" unless="oracle.home.defined">
    <echo>
      IMPORTANT REMINDER: Environment variable $ORACLE_HOME does not appear to be set.  If you are using Oracle, you
               must manually install the Oracle JDBC driver (${oracle.driver.name}.jar) into $GUS_HOME/lib/java/db_driver
               and (optionally) into your local Maven repository.
    </echo>
  </target>

  <target name="copyLocalOracleDriver" if="oracle.home.complete">
    <echo>Removing old versions of Oracle driver from GUS_HOME</echo>
    <echo>Installing local ${oracle.driver.name}.jar from ${env.ORACLE_HOME}/jdbc/lib/${oracle.driver.name}.jar</echo>
    <copy file="${env.ORACLE_HOME}/jdbc/lib/${oracle.driver.name}.jar"
          toDir="${targetDir}/lib/java/db_driver"
          overwrite="true"/>
    <echo>Installing local ${oracle.driver.name}.jar into local Maven repository</echo>
    <exec dir="${projectsDir}/${project}"
          executable="mvn"
          failonerror="true"
          failifexecutionfails="true">
      <arg line="install:install-file"/>
      <arg line="--quiet"/>
      <arg line="-DgroupId=com.oracle"/>
      <arg line="-DartifactId=${oracle.driver.name}"/>
      <arg line="-Dversion=${oracle.version}"/>
      <arg line="-Dpackaging=jar"/>
      <arg line="-Dfile=${env.ORACLE_HOME}/jdbc/lib/${oracle.driver.name}.jar"/>
      <arg line="-DgeneratePom=true"/>
    </exec>
  </target>

  <target name="WDK/Service-Installation">
    <ant target="defaultComponentInstall">
      <property name="project" value="WDK"/>
      <property name="component" value="Service"/>
    </ant>
    <ant target="WDK-Service-Schema"/>
  </target>

  <target name="WDK-Service-Schema" depends="installYarnBin">
    <echo message="Resolving and merging JSON Schema files"/>
    <exec dir="${targetDir}/bin"
          executable="installSchema.sh"
          failonerror="true"
          failifexecutionfails="true">
      <arg line="${projectsDir} ${targetDir}"/>
    </exec>
    <ant target="createSchemaJar"/>
  </target>

  <target name="createSchemaJar">
    <echo message="Creating JSON schema jar file at ${targetDir}/lib/java/wdk-service-schema.jar"/>
    <exec dir="${targetDir}/doc/WDK/Service"
          executable="jar"
          failonerror="true"
          failifexecutionfails="true">
      <arg line="cf ${targetDir}/lib/java/wdk-service-schema.jar schema"/>
    </exec>
  </target>

  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooo  Web Installation  oooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="WDK-WebInstallation" depends="WSF-WebInstallation,
                                              GusHome,
                                              WDK/Service-WebInstallation">
    <echo message="." />
    <echo message="IMPORTANT REMINDER: If you have not already done so, please copy any .jar needed for database connectivity (such as the oracle file ojdbc14.jar) from ${targetDir}/lib/java/db_driver into your webapp server's designated place (such as common/lib for Tomcat). See the installation instructions available at www.gusdb.org/wdk for details."  />
    <echo message="." />
  </target>

  <target name="WDK/Service-WebInstallation" depends="WDK/Service-Installation,installYarnBin">
    <ant target="runRaml2Html"/>
  </target>

  <!-- raml2html is installed in the install project (see install/package.json). -->
  <!-- It is then called via yarn (e.g., `yarn raml2html -i ... -o ...`). -->
  <target name="runRaml2Html" depends="installYarnBin,installYarnDepsForInstallProject">
    <echo>Generating RAML HTML doc</echo>
    <echo>  Input:  ${targetDir}/doc/WDK/Service/raml/api.raml</echo>
    <echo>  Output: ${htdocsTargetDir}/service-api.html</echo>
    <mkdir dir="${htdocsTargetDir}"/>
    <exec executable="yarn"
          failonerror="true"
          failifexecutionfails="true">
      <arg line="raml2html"/>
      <arg line="--theme raml2html-plain-theme"/>
      <arg line="-i ${targetDir}/doc/WDK/Service/raml/api.raml"/>
      <arg line="-o ${htdocsTargetDir}/service-api.html"/>
    </exec>
  </target>

  <target name="GusHome" depends="WDK-Installation,
                                  checkLinks,
                                  webInfDir,
                                  libLink,
                                  configLink,
                                  binLink,
                                  dataLink,
                                  rngLink,
                                  perlLink,
                                  xmlLink,
                                  wdkLink"/>

  <target name="checkLinks">
     <available file="${webappTargetDir}/WEB-INF" property="webInfDirExists"/>
     <available file="${webappTargetDir}/WEB-INF/lib" property="libLinkExists"/>
     <available file="${webappTargetDir}/WEB-INF/wdk-model/config" property="configLinkExists"/>
     <available file="${webappTargetDir}/WEB-INF/wdk-model/bin" property="binLinkExists"/>
     <available file="${webappTargetDir}/WEB-INF/wdk-model/data" property="dataLinkExists"/>
     <available file="${webappTargetDir}/WEB-INF/wdk-model/lib/rng" property="rngLinkExists"/>
     <available file="${webappTargetDir}/WEB-INF/wdk-model/lib/perl" property="perlLinkExists"/>
     <available file="${webappTargetDir}/WEB-INF/wdk-model/lib/xml" property="xmlLinkExists"/>
     <available file="${webappTargetDir}/WEB-INF/wdk-model/lib/wdk" property="wdkLinkExists"/>
  </target>

  <target name="webInfDir" unless="webInfDirExists">
    <mkdir dir="${webappTargetDir}/WEB-INF"/>
  </target>

  <target name="libLink" unless="libLinkExists">
    <symlink link="${webappTargetDir}/WEB-INF/lib" resource="${targetDir}/lib/java"/>
  </target>

  <target name="configLink" unless="configLinkExists">
    <mkdir dir="${webappTargetDir}/WEB-INF/wdk-model"/>    
    <symlink link="${webappTargetDir}/WEB-INF/wdk-model/config" resource="${targetDir}/config"/>
  </target>

  <target name="binLink" unless="binLinkExists">
    <symlink link="${webappTargetDir}/WEB-INF/wdk-model/bin" resource="${targetDir}/bin"/>
  </target>

  <target name="dataLink" unless="dataLinkExists">
    <symlink link="${webappTargetDir}/WEB-INF/wdk-model/data" resource="${targetDir}/data"/>
  </target>

  <target name="rngLink" unless="rngLinkExists">
    <mkdir dir="${webappTargetDir}/WEB-INF/wdk-model/lib"/>    
    <symlink link="${webappTargetDir}/WEB-INF/wdk-model/lib/rng" resource="${targetDir}/lib/rng"/>
  </target>

  <target name="perlLink" unless="perlLinkExists">
    <mkdir dir="${webappTargetDir}/WEB-INF/wdk-model/lib"/>    
    <symlink link="${webappTargetDir}/WEB-INF/wdk-model/lib/perl" resource="${targetDir}/lib/perl"/>
  </target>

  <target name="xmlLink" unless="xmlLinkExists">
    <symlink link="${webappTargetDir}/WEB-INF/wdk-model/lib/xml" resource="${targetDir}/lib/xml"/>
  </target>

  <target name="wdkLink" unless="wdkLinkExists">
    <symlink link="${webappTargetDir}/WEB-INF/wdk-model/lib/wdk" resource="${targetDir}/lib/wdk"/>
  </target>

  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooo  Release  ooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="WDK-Release">
    
    <ant target="defaultProjectRelease">
      <property name="cvsroot" value=":ext:cvs.sanger.ac.uk:/cvsroot/GUS"/>
    </ant>
  </target>  

  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo  Distributable  ooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="WDK-Distributable">

    <copy todir="${targetDir}">
      <fileset dir="${projectsDir}" >
        <exclude name="**/CVS/*" />
      </fileset>
    </copy>  
  </target>  

</project>

